<html>
<style>
body {
  width: 1024px;
}
textarea {
  resize: none;
  outline: none;
  caret-color: transparent;
  -webkit-box-shadow: none;
  -moz-box-shadow: none;
  box-shadow: none;
  overflow: auto;
}
.main {
  padding-top: 10px;
  padding-left: 10px;
  padding-right: 10px;
  width: 100%;
  background: #d8d8d8;
}
</style>
<body>

<div class="main">
<div>
  <canvas id="rxtx" width="1024" height="16">
</div>
<div>
  <canvas id="waterfall" width="2048" height="128" onMouseMove="canvasPointerPos(this,event)" style="width:100%; height: 128px;"></canvas>
</div>
<br />
<div>
  <textarea ondblclick="dblClickEvt(this)" readonly id="lb" rows="10" style="width: 500px;">
CQ LB5SH
CQ LA9KOA
CQ LB5RH
CQ LB2PJ
CQ LB1DK
</textarea>
  <textarea readonly id="rb" rows="10" style="width: 500px;">LB5SH QSY QRM</textarea>
</div>

<br />

<div>
  <input id="stopButton" type="button" value="Stop" onClick="socket.send('Event:stopButton:click')">
  <input id="monitorButton" type="button" value="Monitor" onClick="socket.send('Event:monitorButton:click')">
  <input id="eraseButton" type="button" value="Erase" onClick="socket.send('Event:eraseButton:click')">
  <input id="autoButton" type="button" value="Enable Tx" onClick="socket.send('Event:autoButton:click')">
  <input id="haltTxButton" type="button" value="Halt Tx" onClick="socket.send('Event:stopTxButton:click')">
  <input id="callSign" type="text" value="">
</div>

<div>
  <input id="ft4Button" type="button" value="FT4" onClick="socket.send('Event:ft4Button:click')">
  <input id="ft8Button" type="button" value="FT8" onClick="socket.send('Event:ft8Button:click')">
</div>

<br />

</div>

<script>

const palette = [];

let socket=new WebSocket("ws://localhost:14444");

var wsjtx_settings = new Map();

var m_autoButton = false;
var m_selFreq;

// Initialize rxtx bar
var crxtx = document.getElementById("rxtx");
var ctxrx = crxtx.getContext("2d");
ctxrx.fillStyle="#c8c8c8";
ctxrx.fillRect(0, 0, crxtx.width, crxtx.height);


// Initialize waterfall
var c = document.getElementById("waterfall");
var ctx = c.getContext("2d");
ctx.fillStyle="#000000";
ctx.fillRect(0, 0, c.width, c.height);

c.addEventListener('click', function(e) {
  wsjtx_settings.set("Common/RxFreq",(m_selFreq*3).toString());
  socket.send("Event:RxFreq:" + m_selFreq);
  redrawRxTxBars();
});

c.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  wsjtx_settings.set("Common/TxFreq",(m_selFreq*3).toString());
  socket.send("Event:RxFreq:" + m_selFreq);
  redrawRxTxBars();
});

/* socket event handlers */

socket.onopen = () => {
  console.log("socket open");
}

socket.onclose = function(e)
{
  console.log("Server connection lost");
}

socket.onmessage = (message) =>
{
  var content = message.data.toString();
  var items=content.split(':');
  var cmd = items[0] ?? "";

  if(cmd == "Boot")
  {
    console.log("Boot command received");
    initAllSettings();
  }

  if(items.length == 2)
  {
    if(cmd == "WaterFall")
    {
      var img = ctx.getImageData(0,0,c.width,c.height-1);
      ctx.putImageData(img, 0, 1);
  
      var pixels=items[1].split(',');
  
      for(i=0; i<pixels.length; i++)
      {
        var ii = (Number("0x"+pixels[i]));
        ctx.fillStyle=palette[ii];
        ctx.fillRect(i, 0, 1, 1);
      }
    }
    else if(cmd == "Palette")
    {
      const cols = items[1].split(',');
      for(var i=0; i<(cols.length-1); i++)
      {
        palette.push(cols[i]);
      }
    }
  }

  if(items.length != 3) return;

  if(cmd == "Event")
  {
    console.log("Received event: " + content);
    var obj = items[1];
    var method = items[2];
    if(method == "pressed()")
    {
      switch(obj)
      {
        case "autoButton":     clickAutoButton();       break;
        case "monitorButton":  clickMonitorButton();    break;
      }
    }
  }
  else if(cmd == "Settings")
  {
    var key = items[1];
    var value = items[2];
    wsjtx_settings.set(key,value);
  }
}

/*****************************************************/

function initAllSettings()
{
  clickMonitorButton(false);
  redrawRxTxBars();

  // Common/TxFreq 
}

/*****************************************************/

function clickMonitorButton(toggle=true)
{
  var value = (wsjtx_settings.get("Configuration/MonitorOFF")==='true');
  if(toggle)
  {
    value = value ? false:true;
    wsjtx_settings.set("Configuration/MonitorOFF", value.toString());
  }
  document.getElementById("monitorButton").style.background = value ? "":"#00ff00";
}

function clickAutoButton()
{
  m_autoButton = !m_autoButton;
  document.getElementById("autoButton").style.background = (m_autoButton == true ? "#ff0000":"");
}

function canvasPointerPos(c,e)
{
  var rect = c.getBoundingClientRect();
  var xpos = (e.clientX - rect.left);
  m_selFreq = xpos;
}

//
// Draw red/green bars for RX/TX QRG indicators
//

function redrawRxTxBars()
{
  var rxFreq = parseInt(wsjtx_settings.get("Common/RxFreq"))/3;
  var txFreq = parseInt(wsjtx_settings.get("Common/TxFreq"))/3;

  console.log("redrawRxTxBars: rx=" + rxFreq + ", tx=" + txFreq);

  ctxrx.fillStyle="#c8c8c8";
  ctxrx.fillRect(0, 0, crxtx.width, crxtx.height);

  ctxrx.fillStyle="#c80000";
  ctxrx.fillRect(txFreq,    2, 25, 2);
  ctxrx.fillRect(txFreq,    4,  2, 4);
  ctxrx.fillRect(txFreq+23, 4,  2, 4);

  ctxrx.fillStyle="#00c800";
  ctxrx.fillRect(rxFreq,    12, 25, 2);
  ctxrx.fillRect(rxFreq,    8,  2, 4);
  ctxrx.fillRect(rxFreq+23, 8,  2, 4);

}

</script>

</body>
</html>
