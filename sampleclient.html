<html>
<style>
body {
  width: 1024px;
}
textarea {
  resize: none;
  outline: none;
  caret-color: transparent;
  -webkit-box-shadow: none;
  -moz-box-shadow: none;
  box-shadow: none;
  overflow: auto;
}
.main {
  padding-top: 10px;
  padding-left: 10px;
  padding-right: 10px;
  width: 100%;
  background: #d8d8d8;
}
</style>
<body>

<div class="main">
<div>
  <canvas id="waterfall" width="1024" height="128" onMouseMove="canvasPointerPos(this,event)"></canvas>
</div>
<br />
<div>
  <textarea readonly id="lb" rows="10" style="width: 500px;">CQ LB5SH</textarea>
  <textarea readonly id="rb" rows="10" style="width: 500px;">LB5SH QSY QRM</textarea>
</div>

<br />

<div>
  <input id="stopButton" type="button" value="Stop" onClick="stopButtonClicked()">
  <input id="eraseButton" type="button" value="Erase" onClick="eraseButtonClicked()">
  <input id="autoButton" type="button" value="Enable Tx" onClick="autoButtonClicked()">
  <input id="haltTxButton" type="button" value="Halt Tx" onClick="haltButtonClicked()">
  <input id="callSign" type="text" value="">
</div>

<br />

</div>

<script>

let socket=new WebSocket("ws://localhost:14444");
const palette = [];

// Initialize waterfall
var c = document.getElementById("waterfall");
var ctx = c.getContext("2d");
ctx.fillStyle="#000000";
ctx.fillRect(0, 0, c.width, c.height);

/* socket event handlers */

socket.onopen = () => {
  console.log("socket open");
  socket.send('Request:Settings');
}

socket.onmessage = (message) => {
  var content = message.data.toString();
  //console.log("Received: " + content);

  if(content.startsWith("WaterFall:"))
  {
    content = content.replace(/^WaterFall:/, "");
    console.log("Waterfall data received ");

    var img = ctx.getImageData(0,0,1024,127);
    ctx.putImageData(img, 0, 1);

    var pixels=content.split(',');

    for(i=0; i<pixels.length; i++)
    {
      var ii = (Number("0x"+pixels[i]));
      ctx.fillStyle=palette[ii];
      ctx.fillRect(i, 0, 1, 1);
    }
  }
  else if(content.startsWith("Settings:"))
  {
    content = content.replace(/^Settings:/, "");

    if(content.startsWith("Palette:"))
    {
      content = content.replace(/^Palette:/, "");
      const cols = content.split(',');
      for(var i=0; i<(cols.length-1); i++)
      {
        palette.push(cols[i]);
      }
      console.log("Waterfall palette of " + (cols.length-1) + " entries received");
    }
    else if(content.startsWith("CallSign:"))
    {
      content = content.replace(/^CallSign:/, "");
      console.log("Received current callsign: " + content);
      document.getElementById("callSign").value = content;
    }
  }
  else if(content.startsWith("Event:"))
  {
    console.log("Event received");
    content = content.replace(/^Event:/, "");
    if(content.startsWith("Button:"))
    {
      console.log("Button press received");
      content = content.replace(/^Button:/, "");
      if(content.startsWith("autoButton:"))
      {
        content = content.replace(/^autoButton:/, "");
        if(content == "enabled")
        {
          document.getElementById("autoButton").style.background = "";
        }
        else
        {
          document.getElementById("autoButton").style.background = "#ff0000";
        }
      }
      else
      {
        console.log("Unknown button: " + content);
      }
    } else {
      console.log("Unknown event: " + content);
    }
  }
}

// Discriminate "Erase" button, single or double click 
document.getElementById("eraseButton").onclick = event =>
{
  if(event.detail === 1)
  {
    document.getElementById("lb").value="";
  }
  else if(event.detail === 2)
  {
    document.getElementById("lb").value="";
    document.getElementById("rb").value="";
  }
};
function autoButtonClicked() {
  socket.send('Event:Button:autoButton');
}
function haltButtonClicked() {
  socket.send('Event:Button:haltButton');
}
function canvasPointerPos(c,e)
{
  var rect = c.getBoundingClientRect();
  var xpos = e.clientX - rect.left;
  var ypos = e.clientY - rect.top;
  console.log("x=" + xpos + ", y=" + ypos);
}
</script>

</body>
</html>
