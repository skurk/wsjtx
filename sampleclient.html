<html>
<style>
body {
  width: 1024px;
}
.main {
  padding-top: 10px;
  padding-left: 10px;
  padding-right: 10px;
  width: 100%;
  background: #d8d8d8;
}
</style>
<body>

<div class="main">
<div>
  <canvas id="waterfall" width="1024" height="128"></canvas>
</div>
<br />
<div>
  <select name="lb" size="10" style="width: 500px;">
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
  </select>
  <select name="rb" size="10" style="width: 500px; float: right;">
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
    <option value=""></option>
  </select>
</div>

<br />

<div>
  <input id="stopButton" type="button" value="Stop" onClick="stopButtonClicked()">
  <input id="eraseButton" type="button" value="Erase" onClick="eraseButtonClicked()">
  <input id="autoButton" type="button" value="Enable Tx" onClick="autoButtonClicked()">
  <input id="haltTxButton" type="button" value="Halt Tx" onClick="haltButtonClicked()">
  <input id="callSign" type="text" value="">
</div>

<br />

</div>

<script>
let socket=new WebSocket("ws://localhost:14444");
var c = document.getElementById("waterfall");
var ctx = c.getContext("2d");
const palette = [];

socket.onopen = () => {
  console.log("socket open");
  socket.send('Request:Settings');
  ctx.fillStyle="#000000";
  ctx.fillRect(0,0,1024,256);
}
socket.onmessage = (message) => {
  var content = message.data.toString();
  //console.log("Received: " + content);

  if(content.startsWith("WaterFall:"))
  {
    content = content.replace(/^WaterFall:/, "");
    console.log("Waterfall data received ");

    var img = ctx.getImageData(0,0,1024,127);
    ctx.putImageData(img, 0, 1);

    var pixels=content.split(',');

    for(i=0; i<pixels.length; i++)
    {
      var ii = (Number("0x"+pixels[i]));
      ctx.fillStyle=palette[ii];
      ctx.fillRect(i, 0, 1, 1);
    }
  }
  else if(content.startsWith("Settings:"))
  {
    content = content.replace(/^Settings:/, "");

    if(content.startsWith("Palette:"))
    {
      content = content.replace(/^Palette:/, "");
      const cols = content.split(',');
      for(var i=0; i<(cols.length-1); i++)
      {
        palette.push(cols[i]);
      }
      console.log("Waterfall palette of " + (cols.length-1) + " entries received");
    }
    else if(content.startsWith("CallSign:"))
    {
      content = content.replace(/^CallSign:/, "");
      console.log("Received current callsign: " + content);
      document.getElementById("callSign").value = content;
    }
  }
  else if(content.startsWith("Event:"))
  {
    console.log("Event received");
    content = content.replace(/^Event:/, "");
    if(content.startsWith("Button:"))
    {
      console.log("Button press received");
      content = content.replace(/^Button:/, "");
      if(content.startsWith("autoButton:"))
      {
        content = content.replace(/^autoButton:/, "");
        if(content == "enabled")
        {
          document.getElementById("autoButton").style.background = "";
        }
        else
        {
          document.getElementById("autoButton").style.background = "#ff0000";
        }
      }
      else
      {
        console.log("Unknown button: " + content);
      }
    } else {
      console.log("Unknown event: " + content);
    }
  }
}
function autoButtonClicked() {
  socket.send('Event:Button:autoButton');
}
function haltButtonClicked() {
  socket.send('Event:Button:haltButton');
}
</script>

</body>
</html>
